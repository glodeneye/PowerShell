# CVE-2023-23397 Scanner & Remediation

[← Back to Main Repository](../)

## Overview

Automated detection and remediation script for CVE-2023-23397, a critical Microsoft Outlook elevation of privilege vulnerability that allows attackers to steal NTLM hashes without user interaction.

## Vulnerability Details

### CVE-2023-23397

- **CVSSv3 Score**: 9.8 (Critical)
- **Attack Vector**: Network
- **User Interaction**: None Required
- **Impact**: Credential Theft, Elevation of Privilege

### What Makes This Dangerous?

This vulnerability allows attackers to:
- Steal NTLM authentication hashes **without user interaction**
- Send specially crafted emails to trigger the exploit
- Compromise credentials even if email is never opened
- Use stolen hashes for pass-the-hash attacks
- Escalate privileges on the network

### Attack Scenario

1. Attacker sends crafted email with malicious reminder/task
2. Outlook automatically processes the reminder
3. NTLM authentication hash sent to attacker's server
4. Attacker captures and cracks hash or uses pass-the-hash
5. Attacker gains access to victim's account/network

## Features

- **Automatic Detection**: Identifies vulnerable Outlook installations
- **Version Checking**: Checks both 32-bit and 64-bit Office
- **Update Prompting**: Guides users through patching process
- **Silent Mode**: Option for automated deployment
- **Logging**: Tracks remediation actions
- **Cross-Version**: Supports Office 2013-2021 and Microsoft 365

## Prerequisites

### Requirements

- **PowerShell 5.1+**: Built into Windows 10/11
- **Office/Outlook**: Microsoft Outlook installed
- **Internet Connection**: Required to download patches
- **User Permissions**: Standard user (updates may require elevation)

### Supported Versions

- Microsoft Outlook 2013
- Microsoft Outlook 2016
- Microsoft Outlook 2019
- Microsoft Outlook 2021
- Microsoft 365 Apps for Enterprise

## Installation

### Option 1: Clone Repository

```powershell
git clone https://github.com/goldeneye/PowerShell.git
cd PowerShell\CVE-2023-23397-Scanner
```

### Option 2: Direct Download

```powershell
Invoke-WebRequest -Uri "https://raw.githubusercontent.com/goldeneye/PowerShell/main/CVE-2023-23397-Scanner/CVE-2023-23397-Scanner.ps1" -OutFile "CVE-2023-23397-Scanner.ps1"
```

## Usage

### Interactive Mode (Default)

```powershell
# Run script - prompts user to update
.\CVE-2023-23397-Scanner.ps1
```

**Behavior**:
- Detects Office installation (32-bit or 64-bit)
- Checks for available updates
- Prompts user: "Updates available - install now?"
- If updates current: Shows "You're up to date!"

### Silent/Automated Mode

```powershell
# Force update without user prompt
# Modify script to use: /update user forceappshutdown=true displaylevel=false
```

### Enterprise Deployment

```powershell
# Deploy via SCCM, Group Policy, or remote execution
Invoke-Command -ComputerName $computers -FilePath ".\CVE-2023-23397-Scanner.ps1"
```

## How It Works

### Detection Logic

```powershell
1. Check for 64-bit Office installation
   Path: C:\Program Files\Common Files\microsoft shared\ClickToRun\OfficeC2RClient.exe

2. Check for 32-bit Office installation
   Path: C:\Program Files (x86)\Common Files\microsoft shared\ClickToRun\OfficeC2RClient.exe

3. Execute OfficeC2RClient.exe with update arguments
```

### OfficeC2RClient Arguments

The script uses these arguments by default:

```
/update user updatepromptuser=true
```

**Other Available Arguments**:

| Argument | Effect |
|----------|--------|
| `updatepromptuser=true` | Shows GUI prompt for user consent |
| `displaylevel=false` | Suppresses on-screen update progress |
| `forceappshutdown=true` | Forcibly closes Office apps to update |
| `/update user` (alone) | More forceful, may auto-install |

## Output Examples

### When Updates Available

```
64 Bit Office installed: True
32 Bit Office installed: False
[Office Update Dialog Opens]
"Updates are available. Install now?"
```

### When Already Updated

```
64 Bit Office installed: True
32 Bit Office installed: False
[Office Update Dialog Opens]
"You're up to date!"
```

### When Office Not Found

```
64 Bit Office installed: False
32 Bit Office installed: False
[No action taken]
```

## Use Cases

### Individual Workstation

```powershell
# Run on single PC to check and update
.\CVE-2023-23397-Scanner.ps1
```

### Enterprise Mass Deployment

```powershell
# Get all domain computers
$computers = Get-ADComputer -Filter * | Select-Object -ExpandProperty Name

# Execute remotely
Invoke-Command -ComputerName $computers -FilePath ".\CVE-2023-23397-Scanner.ps1"

# Generate compliance report
$results = Invoke-Command -ComputerName $computers -ScriptBlock {
    $64bit = Test-Path "C:\Program Files\Common Files\microsoft shared\ClickToRun\OfficeC2RClient.exe"
    $32bit = Test-Path "C:\Program Files (x86)\Common Files\microsoft shared\ClickToRun\OfficeC2RClient.exe"
    [PSCustomObject]@{
        ComputerName = $env:COMPUTERNAME
        OfficeInstalled = $64bit -or $32bit
        Architecture = if ($64bit) { "64-bit" } elseif ($32bit) { "32-bit" } else { "None" }
    }
}

$results | Export-Csv "CVE-2023-23397_Scan_Results.csv" -NoTypeInformation
```

### SOC Incident Response

```powershell
# Emergency patching during active exploitation
$criticalSystems = @("DC01", "EXCH01", "FILE01", "CEO-PC")

Invoke-Command -ComputerName $criticalSystems -ScriptBlock {
    $path64 = "C:\Program Files\Common Files\microsoft shared\ClickToRun\OfficeC2RClient.exe"
    $path32 = "C:\Program Files (x86)\Common Files\microsoft shared\ClickToRun\OfficeC2RClient.exe"

    if (Test-Path $path64) {
        Start-Process $path64 -ArgumentList "/update user forceappshutdown=true" -Wait
    }
    if (Test-Path $path32) {
        Start-Process $path32 -ArgumentList "/update user forceappshutdown=true" -Wait
    }
}
```

### Compliance Reporting

```powershell
# Check patch status across organization
.\CVE-2023-23397-Scanner.ps1 | Out-File "CVE_Scan_$(Get-Date -Format 'yyyy-MM-dd').log"

# Parse results for dashboard
# Track: Total systems, Patched, Unpatched, No Office
```

## Manual Patching (Alternative)

If automated script fails:

### Windows Update

```
Settings → Update & Security → Windows Update → Check for updates
```

### Microsoft Update Catalog

1. Visit: https://www.catalog.update.microsoft.com/
2. Search: "CVE-2023-23397"
3. Download appropriate patch for your Office version
4. Install manually

### Office Click-to-Run Update

```
File → Account → Update Options → Update Now
```

## Verification

### Check Office Version

```powershell
# Check installed Office version
Get-ItemProperty "HKLM:\SOFTWARE\Microsoft\Office\ClickToRun\Configuration" | Select-Object VersionToReport

# Compare against patched versions:
# Office 2016: 16.0.5387.1000 or later
# Office 2019: 16.0.10392.20029 or later
# Microsoft 365: 16.0.16130.20218 or later
```

### Verify Patch Installation

```powershell
# List installed updates
Get-HotFix | Where-Object { $_.Description -like "*KB5023307*" }

# Or check via WMIC
wmic qfe list | findstr "KB5023307"
```

## Troubleshooting

### Script Runs But Nothing Happens

**Problem**: No Office detected

**Solutions**:
```powershell
# Manually check paths
Test-Path "C:\Program Files\Common Files\microsoft shared\ClickToRun\OfficeC2RClient.exe"
Test-Path "C:\Program Files (x86)\Common Files\microsoft shared\ClickToRun\OfficeC2RClient.exe"

# If using MSI version (not Click-to-Run), use Windows Update instead
```

### Update Fails to Install

**Problem**: Update process fails or hangs

**Solutions**:
1. Close all Office applications
2. Run script as Administrator
3. Ensure stable internet connection
4. Check disk space (>2GB free)
5. Run Office Repair Tool

```powershell
# Office Repair
Start-Process "control" -ArgumentList "appwiz.cpl" -Wait
# Select Microsoft Office → Change → Quick Repair
```

### How to Identify Office Type

**Click-to-Run vs MSI**:

```powershell
# Check if Click-to-Run
$ctr = Test-Path "HKLM:\SOFTWARE\Microsoft\Office\ClickToRun\Configuration"
if ($ctr) {
    Write-Host "Office uses Click-to-Run (this script works)" -ForegroundColor Green
} else {
    Write-Host "Office uses MSI (use Windows Update instead)" -ForegroundColor Yellow
}
```

## Detection and Response

### Hunt for Exploitation

```powershell
# Check Outlook logs for suspicious UNC paths
$outlookLogs = Get-ChildItem -Path "$env:TEMP\Outlook Logging" -Recurse -ErrorAction SilentlyContinue
$outlookLogs | Select-String -Pattern "\\\\[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+"

# Review Windows Security logs for NTLM authentication to unusual IPs
Get-WinEvent -FilterHashtable @{LogName='Security'; ID=4624,4625} |
    Where-Object { $_.Message -match "NTLM" }
```

### Indicators of Compromise

Look for:
- Unexpected network connections from Outlook.exe
- NTLM authentication to external IPs
- Email headers with UNC paths (\\server\share)
- Automatic connections without user action

## Security Recommendations

1. **Patch Immediately**: CVE-2023-23397 is actively exploited
2. **Network Segmentation**: Limit NTLM traffic to internet
3. **Disable NTLMv1**: Use only NTLMv2 or Kerberos
4. **Monitor NTLM**: Set up alerts for unusual NTLM auth
5. **Email Filtering**: Block emails with suspicious UNC paths

## Mitigation (If Patching Delayed)

### Registry-Based Mitigation

```powershell
# Block UNC paths in Outlook (temporary workaround)
$path = "HKCU:\Software\Microsoft\Office\16.0\Outlook\Security"
New-ItemProperty -Path $path -Name "BlockHTMLRememberedForms" -Value 1 -PropertyType DWORD -Force

# Disable automatic processing of meeting requests
Set-ItemProperty -Path "HKCU:\Software\Microsoft\Office\16.0\Outlook\Options\Calendar" -Name "DisableAutomaticProcessing" -Value 1
```

**Note**: These are workarounds, not replacements for patching.

## References

- **NVD**: https://nvd.nist.gov/vuln/detail/CVE-2023-23397
- **Microsoft Advisory**: https://msrc.microsoft.com/update-guide/vulnerability/CVE-2023-23397
- **CISA Alert**: https://www.cisa.gov/uscert/ncas/current-activity/2023/03/14/microsoft-releases-security-updates
- **Exploit Analysis**: Various security research publications

## Related Scripts

- [Disable-Enable AutoRun](../Disable-Enable-AutoRun/) - System security hardening
- [Get-OneDriveSharedItems](../Get-OneDriveSharedItems/) - OneDrive security audit

## Support

- **Issues**: [GitHub Issues](https://github.com/goldeneye/PowerShell/issues)
- **Discussions**: [GitHub Discussions](https://github.com/goldeneye/PowerShell/discussions)

## Contributing

Found a bug or have an enhancement? Contributions welcome!

1. Fork the repository
2. Create feature branch
3. Make your changes
4. Submit pull request

## License

MIT License - see [LICENSE](../LICENSE) for details

## Author

**Tim Golden**
- GitHub: [@goldeneye](https://github.com/goldeneye)
- Website: [timgolden.com](https://timgolden.com)

## Timeline

- **March 2023**: Vulnerability disclosed
- **March 2023**: Active exploitation observed
- **March 14, 2023**: Microsoft releases patches
- **March 2023**: Added to CISA KEV catalog

---

**URGENT**: This is a critical, actively exploited vulnerability. Patch immediately.

---

*Last Updated: October 2025*
